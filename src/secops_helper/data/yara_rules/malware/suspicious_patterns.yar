rule Suspicious_Powershell_Encoded
{
    meta:
        description = "Detects PowerShell scripts with encoded commands"
        author = "SecOps Helper"
        severity = "medium"
        date = "2025-11-20"

    strings:
        $ps1 = "powershell" nocase
        $ps2 = "pwsh" nocase
        $encoded1 = "-encodedcommand" nocase
        $encoded2 = "-enc" nocase
        $encoded3 = "-e " nocase
        $base64 = /[A-Za-z0-9+\/]{50,}={0,2}/

    condition:
        ($ps1 or $ps2) and ($encoded1 or $encoded2 or $encoded3) and $base64
}

rule Suspicious_Downloader
{
    meta:
        description = "Detects potential malware downloaders"
        author = "SecOps Helper"
        severity = "high"
        date = "2025-11-20"

    strings:
        $download1 = "DownloadFile" nocase
        $download2 = "DownloadString" nocase
        $download3 = "Invoke-WebRequest" nocase
        $download4 = "wget" nocase
        $download5 = "curl" nocase
        $url = /(https?|ftp):\/\/[^\s<>"{}|\\^`\[\]]+/
        $exec1 = "Invoke-Expression" nocase
        $exec2 = "IEX" nocase
        $exec3 = "Start-Process" nocase

    condition:
        2 of ($download*) and $url and any of ($exec*)
}

rule Suspicious_Registry_Persistence
{
    meta:
        description = "Detects registry persistence mechanisms"
        author = "SecOps Helper"
        severity = "medium"
        date = "2025-11-20"

    strings:
        $reg1 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg3 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $reg4 = "HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $cmd1 = "reg add" nocase
        $cmd2 = "Set-ItemProperty" nocase
        $cmd3 = "New-ItemProperty" nocase

    condition:
        any of ($reg*) and any of ($cmd*)
}

rule Suspicious_Anti_Analysis
{
    meta:
        description = "Detects anti-analysis and sandbox evasion techniques"
        author = "SecOps Helper"
        severity = "high"
        date = "2025-11-20"

    strings:
        $vm1 = "VMware" nocase
        $vm2 = "VirtualBox" nocase
        $vm3 = "VBOX" nocase
        $vm4 = "QEMU" nocase
        $sandbox1 = "Sandboxie" nocase
        $sandbox2 = "Cuckoo" nocase
        $debug1 = "IsDebuggerPresent"
        $debug2 = "CheckRemoteDebuggerPresent"
        $debug3 = "OutputDebugString"
        $sleep1 = "Sleep"
        $sleep2 = "Start-Sleep"

    condition:
        2 of ($vm*) or any of ($sandbox*) or (any of ($debug*) and any of ($sleep*))
}
